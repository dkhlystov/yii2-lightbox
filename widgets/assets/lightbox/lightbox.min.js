$(function(){function i(i,t){void 0==t&&(t=i.find(".lightbox-block").data("el"));var a=t.closest(".lightbox").find("a:has(img)"),n=a.index(t)+1,e=a.length;e>1&&i.find(".lightbox-header").html("<span>"+n+"</span>/"+e);var d=i.find(".prev"),o=i.find(".next");n>1?d.removeClass("disabled"):d.addClass("disabled"),n<e?o.removeClass("disabled"):o.addClass("disabled")}function t(i,t){i.data("el",t),i.find(".loading").css("display","block").animate({opacity:1},200),i.find(".buffer img").attr("src","").attr("src",t.attr("href"))}function a(){$(window).unbind("keydown",n);var i=$(".lightbox-overlay");i.animate({opacity:0},200,function(){i.remove()})}function n(i){$(".lightbox-overlay");27==i.keyCode&&a(),37==i.which&&d(),39==i.which&&o()}function e(){var t=$(this),a=t.closest(".lightbox-block"),n=a.find(".preview"),e=a.closest(".lightbox-overlay"),d=a.find(".prev, .next, .close"),o=t.width()+2,l=t.height()+2,s=o/l,c=e.width(),h=e.height(),r=c/h;s>r&&o>c?l=(o=c)/s:s<=r&&l>h&&(o=(l=h)*s),i(e),d.addClass("hidden"),n.animate({opacity:0},200,function(){a.find(".loading").animate({opacity:0},200,function(){$(this).css("display","none")}),n.attr("src",t.attr("src")),n.animate({height:l-2,width:o-2},200),a.animate({height:l,"margin-left":-o/2,"margin-top":-l/2,width:o},200,function(){n.animate({opacity:1},200),d.removeClass("hidden")})})}function d(){var i=$(".lightbox-overlay");if(i.find(".prev").is(".disabled"))return!1;if(i.find(".loading").is(":visible"))return!1;var a=i.find(".lightbox-block"),n=a.data("el"),e=n.closest(".lightbox").find("a:has(img)"),d=e.index(n)-1;d>=0&&t(a,e.eq(d))}function o(){var i=$(".lightbox-overlay");if(i.find(".next").is(".disabled"))return!1;if(i.find(".loading").is(":visible"))return!1;var a=i.find(".lightbox-block"),n=a.data("el"),e=n.closest(".lightbox").find("a:has(img)"),d=e.index(n)+1;d<e.length&&t(a,e.eq(d))}$(document).on("click",".lightbox-overlay",function(i){i.target==this&&a()}),$(document).on("touchstart",".lightbox a:has(img)",function(){$(this).data("touch",!0)}),$(document).on("click",".lightbox a:has(img)",function(l){l.preventDefault();var s,c,h,r=$(this);if(r.data("touch")){var f=r.closest(".lightbox"),v=$('<form method="post"></form>').attr("action",f.data("url"));f.find("a:has(img)").each(function(){$('<input type="hidden" name="src[]" />').val(this.href).appendTo(v)}),$('<input type="hidden" name="touch">').val(this.href).appendTo(v),v.appendTo("body").submit()}else s=r,c=$('<div class="lightbox-overlay"><div class="lightbox-header"></div><div class="lightbox-footer"></div><div class="lightbox-block block-current"><div class="buffer"><img></div><div class="loading"></div><img class="preview"><div class="next hidden"><span>&gt;</span></div><div class="prev hidden"><span>&lt;</span></div><div class="close hidden">&times;</div></div></div>'),h=c.find(".lightbox-block"),i(c,s),c.find(".close").on("click",a),c.find(".prev").on("click",d),c.find(".next").on("click",o),c.find(".buffer img").on("load",e),$(window).bind("keydown",n),t(h,s),c.appendTo("body").css({display:"block",opacity:0}).animate({opacity:1},200)})});
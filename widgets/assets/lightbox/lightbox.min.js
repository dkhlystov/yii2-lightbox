$(function(){function i(i){var e=$('<div class="lightbox-overlay"><div class="lightbox-header"></div><div class="lightbox-footer"></div><div class="lightbox-block block-current"><div class="buffer"><img></div><div class="loading"></div><img class="preview"><div class="next hidden"><span>&gt;</span></div><div class="prev hidden"><span>&lt;</span></div><div class="close hidden">&times;</div></div></div>'),c=e.find(".lightbox-block");t(e,i),e.find(".close").click(n),e.find(".prev").click(l),e.find(".next").click(s),e.find(".buffer img").load(o),$(window).bind("keydown",d),a(c,i),e.appendTo("body").css({display:"block",opacity:0}).animate({opacity:1},200)}function t(i,t){void 0==t&&(t=i.find(".lightbox-block").data("el"));var a=t.closest(".lightbox").find("a:has(img)"),n=a.index(t)+1,e=a.length;e>1&&i.find(".lightbox-header").html("<span>"+n+"</span>/"+e);var d=i.find(".prev"),o=i.find(".next");n>1?d.removeClass("disabled"):d.addClass("disabled"),e>n?o.removeClass("disabled"):o.addClass("disabled")}function a(i,t){i.data("el",t),i.find(".loading").css("display","block").animate({opacity:1},200),i.find(".buffer img").attr("src","").attr("src",t.attr("href"))}function n(){$(window).unbind("keydown",d);var i=$(".lightbox-overlay");i.animate({opacity:0},200,function(){i.remove()})}function e(i){i.target==this&&n()}function d(i){$(".lightbox-overlay");27==i.keyCode&&n(),37==i.which&&l(),39==i.which&&s()}function o(){var i=$(this),a=i.closest(".lightbox-block"),n=a.find(".preview"),e=a.closest(".lightbox-overlay"),d=a.find(".prev, .next, .close"),o=i.width()+2,l=i.height()+2,s=o/l,c=e.width(),h=e.height(),r=c/h;s>r&&o>c?(o=c,l=o/s):r>=s&&l>h&&(l=h,o=l*s),t(e),d.addClass("hidden"),n.animate({opacity:0},200,function(){a.find(".loading").animate({opacity:0},200,function(){$(this).css("display","none")}),n.attr("src",i.attr("src")),n.animate({height:l-2,width:o-2},200),a.animate({height:l,"margin-left":-o/2,"margin-top":-l/2,width:o},200,function(){n.animate({opacity:1},200),d.removeClass("hidden")})})}function l(){var i=$(".lightbox-overlay");if(i.find(".prev").is(".disabled"))return!1;if(i.find(".loading").is(":visible"))return!1;var t=i.find(".lightbox-block"),n=t.data("el"),e=n.closest(".lightbox").find("a:has(img)"),d=e.index(n)-1;d>=0&&a(t,e.eq(d))}function s(){var i=$(".lightbox-overlay");if(i.find(".next").is(".disabled"))return!1;if(i.find(".loading").is(":visible"))return!1;var t=i.find(".lightbox-block"),n=t.data("el"),e=n.closest(".lightbox").find("a:has(img)"),d=e.index(n)+1;d<e.length&&a(t,e.eq(d))}function c(t){t.preventDefault();var a=$(this);if(a.data("touch")){var n=a.closest(".lightbox"),e=$('<form method="post"></form>').attr("action",n.data("url"));n.find("a:has(img)").each(function(){$('<input type="hidden" name="src[]" />').val(this.href).appendTo(e)}),$('<input type="hidden" name="touch">').val(this.href).appendTo(e),e.appendTo("body").submit()}else i(a)}$(document).on("click",".lightbox-overlay",e),$(document).on("touchstart",".lightbox a:has(img)",function(){$(this).data("touch",!0)}),$(document).on("click",".lightbox a:has(img)",c)});